<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Filters - Sentinel</title> <link rel="shortcut icon" href="/sentinel/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/sentinel/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/sentinel/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/sentinel/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Filters | Sentinel</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Filters" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Evaluation utilities" /> <meta property="og:description" content="Evaluation utilities" /> <link rel="canonical" href="/sentinel/filters.html" /> <meta property="og:url" content="/sentinel/filters.html" /> <meta property="og:site_name" content="Sentinel" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Filters" /> <script type="application/ld+json"> {"description":"Evaluation utilities","url":"/sentinel/filters.html","@type":"WebPage","headline":"Filters","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/sentinel/" class="site-title lh-tight"> Sentinel </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/sentinel/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="/sentinel/filters.html" class="nav-list-link active">Filters</a></li><li class="nav-list-item"><a href="/sentinel/config-spec.html" class="nav-list-link">Config specification</a></li><li class="nav-list-item"><a href="/sentinel/roadmap.html" class="nav-list-link">Roadmap</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Sentinel" aria-label="Search Sentinel" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="filters"> <a href="#filters" class="anchor-heading" aria-labelledby="filters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Filters </h1> <p>This page explains what are filter functions and how to write your own filter functions.</p> <p>Filters are functions which:</p> <ul> <li>Take a dataframe as input.</li> <li>Check and apply certain constraints.</li> </ul> <p>and</p> <ul> <li>Return back a smaller, subset of the original dataframe which holds true for the constraints applied by the filter.</li> </ul> <p>Calls/turns from these dataframes are reported as reports via Slack, e-mail etc.</p> <h4 id="example"> <a href="#example" class="anchor-heading" aria-labelledby="example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example </h4> <p>Consider a dataframe below:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>call_uuid,conversation_uuid,alternatives,audio_url,reftime,prediction,state,call_duration,state_transitions
eed0f31c-c5e1-4f5b-aaaa-836c2e2b99f5,eed0f31c-c5e1-4f5b-aaaa-836c2e2b99f5,"[[{""confidence"": 0.9299549, ""transcript"": ""Hindi""}, {""confidence"": 0.04444444, ""transcript"": ""hinadi""}, {""confidence"": 0.48719966, ""transcript"": ""in Hindi""}]]",https://s3.ap-south-1.amazonaws.com/hermes-cca%2F2021-09-27%2Feed0f31c-c5e1-4f5b-aaaa-836c2e2b99f5%2Fc0f5b3ef-da72-4488-8191-b0412685fd3c.flac,2021-09-27 03:37:14.806623 +0000 UTC,"{""name"": ""inform_hindi"", ""score"": 0.9949743324486925, ""slot"": []}",COF,,UPCOMING_FLIGHT_DETAILS_ASYNC -&gt; GET_LANGUAGE_PREFERENCE -&gt; COF -&gt; COF -&gt; SET_LANGUAGE_PREFERENCE -&gt; COF_QUERY -&gt; COF_QUERY -&gt; COF_QUERY -&gt; COF_QUERY -&gt; CONFIRMATION_CANCELLATION_POLICY -&gt; CONFIRMATION_CANCELLATION_POLICY -&gt; CONFIRMATION_CANCELLATION_POLICY -&gt; ACTION_FETCH_UPCOMING_FLIGHT_DETAILS -&gt; BOOKING_DONE -&gt; BOOKING_DONE -&gt; COF_ALPHANUMERIC -&gt; COF_ALPHANUMERIC -&gt; COLLECT_INPUT -&gt; COLLECT_INPUT -&gt; COLLECT_INPUT -&gt; COLLECT_INPUT -&gt; COLLECT_INPUT -&gt; ACTION_GROUP_4 -&gt; GROUP_4_2 -&gt; GROUP_4_2 -&gt; ACTION_CONFIRM_GROUP_4 -&gt; ACTION_GROUP_4 -&gt; GROUP_4_2 -&gt; GROUP_4_2 -&gt; ACTION_CONFIRM_GROUP_4 -&gt; FINAL_CONFIRM -&gt; FINAL_CONFIRM -&gt; FINAL_CONFIRM -&gt; FINAL_CONFIRM -&gt; TRANSFER_AGENT -&gt; NA
</code></pre></div></div> <p>If you apply an <a href="./"><code class="language-plaintext highlighter-rouge">ASRConfidenceFilter</code></a> filter on this dataframe with a threshold of <code class="language-plaintext highlighter-rouge">0.95</code>, this will be marked as an anomalous call because of the low confidence in of the alternatives.</p><hr /> <h3 id="writing-a-custom-filter"> <a href="#writing-a-custom-filter" class="anchor-heading" aria-labelledby="writing-a-custom-filter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing a custom filter </h3> <p>Implement the <a href="./"><code class="language-plaintext highlighter-rouge">FilterBase</code></a> class and register it via <a href="./"><code class="language-plaintext highlighter-rouge">@FilterFactory.register</code></a> decorator to add it to supported filter factory.</p> <p>For example, consider a filter to flag out calls with certain end state.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">FilterFactory</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"call_end_state"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Calls with a particular end state"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EndStateFilter</span><span class="p">(</span><span class="n">FilterBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">end_state</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"end_state"</span><span class="p">,</span> <span class="p">[</span><span class="s">"COF"</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_filter_last_turn</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="p">.</span><span class="n">_filter_state</span><span class="p">,</span> <span class="s">"call_end_state"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_df</span>

    <span class="k">def</span> <span class="nf">_filter_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">end_state</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_filter_last_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">"call_uuid"</span><span class="p">,</span> <span class="s">"state"</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">first</span><span class="p">()</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">"call_uuid"</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s">"last"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_df</span>
</code></pre></div></div> <p>Logic on how filtering is being performed for this particular example might be out of the scope of this doc but the basic steps taken are:</p> <ol> <li>Create a new filter class inheriting the <a href="./"><code class="language-plaintext highlighter-rouge">FilterBase</code></a> ABC and register it with the <a href="./"><code class="language-plaintext highlighter-rouge">FilterFactory</code></a></li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">FilterFactory</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"call_end_state"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Calls with a particular end state"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EndStateFilter</span><span class="p">(</span><span class="n">FilterBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">end_state</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"end_state"</span><span class="p">,</span> <span class="p">[</span><span class="s">"COF"</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="p">...</span>
</code></pre></div></div> <p>Here,</p> <ul> <li><code class="language-plaintext highlighter-rouge">name</code> is the name of this filter which will be used to refer this filter in <a href="./"><code class="language-plaintext highlighter-rouge">config.yml</code></a>.</li> <li><code class="language-plaintext highlighter-rouge">description</code> is the description of this filter which is mostly used while reporting calls over Slack or email.</li> </ul> <p>Any keyword arguments described in the <code class="language-plaintext highlighter-rouge">config.yml</code> (see how to provide keyword arguments in <code class="language-plaintext highlighter-rouge">config.yml</code> <a href="./">here</a>), must be initialzed and in <code class="language-plaintext highlighter-rouge">__init__()</code> like above</p> <ol> <li>For serving dataframes, implement <code class="language-plaintext highlighter-rouge">process()</code> method to filter out a smaller dataframe which matches your filter constraints and return.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">FilterFactory</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"call_end_state"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">"Calls with a particular end state"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EndStateFilter</span><span class="p">(</span><span class="n">FilterBase</span><span class="p">):</span>

    <span class="p">...</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_filter_last_turn</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="p">.</span><span class="n">_filter_state</span><span class="p">,</span> <span class="s">"call_end_state"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_df</span>
        
    <span class="p">...</span>
</code></pre></div></div> <ol> <li>While reporting, sentinel will automatically pick up relevant calls/turns from the dataframe and report. You donâ€™t need to make changes in reporting logic. (You might have to make appropriate changes in the config file).</li> </ol> <h3 id="using-your-newly-created-filters"> <a href="#using-your-newly-created-filters" class="anchor-heading" aria-labelledby="using-your-newly-created-filters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using your newly created filters </h3> <p>Check the <code class="language-plaintext highlighter-rouge">config.yml</code> doc <a href="./">here</a> to see how to add your filter to be used by sentinel.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
